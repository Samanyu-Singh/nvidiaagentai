<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LegalLensIQ - Terms of Service Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .input-section, .results-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .input-section h2, .results-section h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 200px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #4a5568;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-item {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .result-item.risk {
            background: #fef5e7;
            border-left-color: #f6ad55;
        }

        .result-item.compliance {
            background: #f0fff4;
            border-left-color: #68d391;
        }

        .result-item.recommendation {
            background: #fef5e7;
            border-left-color: #f6ad55;
        }

        .score-display {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .score-number {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .score-fair {
            color: #38a169;
        }

        .score-moderate {
            color: #d69e2e;
        }

        .score-unfair {
            color: #e53e3e;
        }

        .status {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        .sample-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }

        .sample-btn:hover {
            background: #2d3748;
        }

        /* Chatbot Styles */
        .chatbot-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .chat-container {
            max-width: 100%;
            margin-top: 1rem;
        }

        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 1rem;
        }

        .message {
            margin-bottom: 1rem;
            display: flex;
        }

        .user-message {
            justify-content: flex-end;
        }

        .bot-message {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.4;
        }

        .user-message .message-content {
            background: #3b82f6;
            color: white;
        }

        .bot-message .message-content {
            background: #f1f5f9;
            color: #1e293b;
            border: 1px solid #e2e8f0;
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .send-btn {
            padding: 0.75rem 1.5rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .send-btn:hover {
            background: #2563eb;
        }

        .send-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: flex;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            background: #f1f5f9;
            border-radius: 12px;
            max-width: 60px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #64748b;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç LegalLensIQ</h1>
            <p>Terms of Service Analyzer - Built with NVIDIA's AgentIQ Toolkit</p>
        </div>

        <div class="input-section">
            <h2>üìÑ Document Input</h2>
            <form id="analysisForm">
                <div class="form-group">
                    <label for="documentTitle">Document Title:</label>
                    <input type="text" id="documentTitle" value="Sample Terms of Service" required>
                </div>
                
                <div class="form-group">
                    <label for="documentType">Document Type:</label>
                    <select id="documentType">
                        <option value="Terms of Service">Terms of Service</option>
                        <option value="Privacy Policy">Privacy Policy</option>
                        <option value="EULA">End User License Agreement</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="documentContent">Document Content:</label>
                    <textarea id="documentContent" placeholder="Paste your legal document here..." required>
Terms of Service

1. Data Collection and Usage
We may collect and sell your personal information to third parties for marketing purposes. 
We also track your browsing history across websites and collect location data.

2. Account Termination
We reserve the right to terminate your account at any time without notice or explanation.

3. Dispute Resolution
All disputes must be resolved through binding arbitration. You waive your right to a jury trial.

4. No Refunds
All sales are final. No refunds will be provided under any circumstances.

5. Privacy Rights
You have the right to know what data we collect, request deletion of your data, and opt out of data sharing. 
California residents have additional rights under CCPA.

By using our service, you waive all legal rights and agree to these terms.</textarea>
                </div>
                
                <button type="submit" class="btn" id="analyzeBtn">üîç Analyze Document</button>
                <button type="button" class="sample-btn" onclick="loadSampleDocument()">Load Sample Document</button>
            </form>
        </div>

        <div class="results-section">
            <h2>üìä Analysis Results</h2>
            <div id="loadingSection" class="loading hidden">
                <div class="spinner"></div>
                <p>Analyzing document...</p>
            </div>
            
            <div id="resultsSection" class="hidden">
                <div class="score-display">
                    <div id="scoreNumber" class="score-number"></div>
                    <div id="status" class="status"></div>
                    <p>Fairness Score</p>
                </div>
                
                <div id="riskAnalysis"></div>
                <div id="complianceCheck"></div>
                <div id="recommendations"></div>
            </div>
        </div>

        <!-- Legal Assistant Chatbot -->
        <div class="chatbot-section">
            <h2>üí¨ Legal Assistant Chatbot</h2>
            <div class="chat-container">
                <div id="chatMessages" class="chat-messages">
                    <div class="message bot-message">
                        <div class="message-content">
                            üëã Hi! I'm your legal assistant. Ask me anything about the analyzed document, legal terms, or privacy concerns. I can explain complex clauses in plain English and help you understand your rights.
                        </div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chatInput" placeholder="Ask about legal terms, privacy, or document analysis..." class="chat-input">
                    <button id="sendMessage" class="send-btn">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced risk patterns for privacy policies and ToS
        const riskPatterns = {
            mandatory_arbitration: [/arbitration.*shall.*determined/gi, /mandatory.*arbitration/gi, /binding.*arbitration/gi, /JAMS.*arbitration/gi, /waive.*right.*jury.*trial/gi],
            broad_liability_waivers: [/no.*liability.*damages/gi, /disclaim.*all.*warranties/gi, /as.*is.*as.*available/gi, /consequential.*damages/gi],
            broad_termination_rights: [/terminate.*account.*without.*notice/gi, /suspend.*account.*sole.*discretion/gi, /violation.*terms.*terminate/gi],
            automatic_renewal: [/automatically.*renew/gi, /auto.*renewal/gi, /recurring.*subscription/gi],
            excessive_data_collection: [/location.*data/gi, /biometric.*identifiers/gi, /faceprints.*voiceprints/gi, /keystroke.*patterns/gi, /clipboard.*information/gi, /social.*network.*contacts/gi, /phone.*contacts/gi, /precise.*location/gi, /GPS.*information/gi, /metadata.*upload/gi, /device.*identifiers/gi, /advertising.*identifiers/gi, /IP.*address.*geolocation/gi],
            no_refunds: [/no.*refunds/gi, /non.*refundable/gi, /all.*sales.*final/gi],
            data_selling: [/sell.*personal.*information/gi, /share.*data.*third.*parties/gi, /advertisers.*share.*information/gi, /business.*partners.*share/gi, /cross.*context.*behavioral.*advertising/gi, /targeted.*advertising/gi, /personalized.*advertising/gi],
            unilateral_changes: [/change.*terms.*any.*time/gi, /update.*privacy.*policy.*time/gi, /reserve.*right.*change/gi],
            sole_discretion_clauses: [/sole.*discretion/gi, /our.*discretion/gi, /company.*discretion/gi],
            waiver_of_rights: [/waive.*all.*rights/gi, /waive.*legal.*rights/gi, /irrevocably.*waive/gi],
            extensive_data_sharing: [/share.*with.*service.*providers/gi, /share.*with.*business.*partners/gi, /share.*with.*advertisers/gi, /corporate.*group.*entities/gi, /global.*company/gi, /international.*transfer/gi, /servers.*outside.*united.*states/gi],
            indefinite_data_retention: [/retain.*as.*long.*necessary/gi, /retain.*legitimate.*business.*interest/gi, /retain.*legal.*obligations/gi, /retain.*improve.*develop/gi, /keep.*account.*long.*account/gi],
            broad_data_use: [/use.*advertising.*marketing/gi, /use.*targeted.*advertising/gi, /use.*personalized.*content/gi, /use.*infer.*information/gi, /use.*demographic.*classification/gi, /use.*content.*recommendations/gi, /use.*machine.*learning/gi, /use.*AI.*training/gi, /use.*research.*purposes/gi],
            lack_of_user_control: [/no.*opt.*out.*data.*collection/gi, /cannot.*opt.*out.*tracking/gi, /required.*data.*collection/gi, /cannot.*disable.*cookies/gi, /cannot.*delete.*account/gi, /limited.*data.*deletion/gi]
        };

        // Enhanced compliance patterns
        const compliancePatterns = {
            gdpr: [/right.*to.*deletion/gi, /data.*portability/gi, /explicit.*consent/gi, /data.*processing.*basis/gi, /privacy.*policy/gi, /data.*protection/gi, /personal.*data.*rights/gi, /lawful.*basis.*processing/gi, /data.*subject.*rights/gi, /privacy.*by.*design/gi],
            coppa: [/children.*under.*13/gi, /parental.*consent/gi, /collect.*child.*data/gi, /age.*verification/gi, /minor.*protection/gi, /children.*privacy.*policy/gi, /guardian.*guide/gi, /parent.*controls/gi],
            ccpa: [/california.*privacy/gi, /opt.*out.*sale/gi, /right.*to.*know/gi, /data.*disclosure/gi, /privacy.*rights.*act/gi, /california.*resident/gi, /personal.*information.*request/gi, /data.*access.*request/gi],
            fair_terms: [/reasonable.*notice/gi, /due.*process/gi, /appeal.*rights/gi, /dispute.*resolution/gi, /mediation/gi, /fair.*terms/gi, /user.*control/gi, /data.*minimization/gi, /purpose.*limitation/gi, /storage.*limitation/gi],
            privacy_best_practices: [/data.*minimization/gi, /purpose.*limitation/gi, /storage.*limitation/gi, /accuracy.*data/gi, /confidentiality.*security/gi, /accountability/gi, /transparency/gi, /user.*consent/gi, /opt.*in.*consent/gi, /granular.*consent/gi]
        };

        // Enhanced risk deductions (nuanced scoring for different company types)
        const riskDeductions = {
            // Major privacy violations (heavily penalized)
            data_selling: 45,                 // Extremely problematic - selling user data
            extensive_data_sharing: 40,       // Major privacy concern - sharing with many parties
            excessive_data_collection: 30,     // Significant concern - but common for personalization
            broad_data_use: 30,               // Significant concern - but common for services
            
            // Standard business practices (moderately penalized)
            mandatory_arbitration: 12,        // Common for tech companies
            broad_liability_waivers: 18,      // Standard business practice
            unilateral_changes: 8,            // Standard practice
            sole_discretion_clauses: 8,       // Common business practice
            automatic_renewal: 8,             // Common subscription model
            
            // Moderate concerns
            lack_of_user_control: 25,         // Significant but varies by service
            indefinite_data_retention: 20,     // Problematic but common
            waiver_of_rights: 18,             // Concerning but standard
            broad_termination_rights: 15,     // Reasonable for service providers
            no_refunds: 6                     // Minor issue
        };

        // Enhanced compliance bonuses (better recognition of good practices)
        const complianceBonuses = {
            gdpr: 18,                    // Important privacy protection
            coppa: 15,                   // Child protection
            ccpa: 15,                    // Consumer rights
            fair_terms: 25,              // Significant positive - transparent practices
            privacy_best_practices: 25   // Significant positive - privacy-first approach
        };

        function findSentenceBoundary(text, position, direction) {
            // Look for sentence boundaries (periods, exclamation marks, question marks)
            const sentenceEndings = /[.!?]\s+/g;
            const sentenceStartings = /[.!?]\s+[A-Z]/g;
            
            if (direction === 'backward') {
                // Look backward for the start of the sentence
                let currentPos = position;
                while (currentPos > 0) {
                    // Check if we found a sentence ending before current position
                    const beforeText = text.substring(0, currentPos);
                    const lastSentenceEnd = beforeText.lastIndexOf('.');
                    const lastExclamation = beforeText.lastIndexOf('!');
                    const lastQuestion = beforeText.lastIndexOf('?');
                    const lastEnding = Math.max(lastSentenceEnd, lastExclamation, lastQuestion);
                    
                    if (lastEnding > 0 && lastEnding < currentPos - 10) {
                        // Found a sentence boundary, return position after it
                        return lastEnding + 1;
                    }
                    
                    // If no sentence boundary found, look for paragraph breaks or line breaks
                    const lastNewline = beforeText.lastIndexOf('\n');
                    if (lastNewline > 0 && lastNewline < currentPos - 20) {
                        return lastNewline + 1;
                    }
                    
                    // Fallback: go back 100 characters or to beginning
                    currentPos = Math.max(0, currentPos - 100);
                    if (currentPos === 0) break;
                }
                return Math.max(0, position - 100);
            } else {
                // Look forward for the end of the sentence
                let currentPos = position;
                while (currentPos < text.length) {
                    const afterText = text.substring(currentPos);
                    const nextSentenceEnd = afterText.search(/[.!?]\s+/);
                    
                    if (nextSentenceEnd > 0) {
                        return currentPos + nextSentenceEnd + 1;
                    }
                    
                    // If no sentence boundary found, look for paragraph breaks
                    const nextNewline = afterText.search(/\n\n/);
                    if (nextNewline > 0) {
                        return currentPos + nextNewline + 2;
                    }
                    
                    // Fallback: go forward 100 characters or to end
                    currentPos = Math.min(text.length, currentPos + 100);
                    if (currentPos === text.length) break;
                }
                return Math.min(text.length, position + 100);
            }
        }

        function detectRisks(content) {
            const risks = {};
            
            for (const [riskType, patterns] of Object.entries(riskPatterns)) {
                const foundClauses = [];
                
                for (const pattern of patterns) {
                    const matches = content.matchAll(pattern);
                    for (const match of matches) {
                        // Find proper sentence boundaries
                        const sentenceStart = findSentenceBoundary(content, match.index, 'backward');
                        const sentenceEnd = findSentenceBoundary(content, match.index + match[0].length, 'forward');
                        const context = content.substring(sentenceStart, sentenceEnd).trim();
                        
                        foundClauses.push({
                            match: match[0],
                            context: context
                        });
                    }
                }
                
                if (foundClauses.length > 0) {
                    risks[riskType] = foundClauses;
                }
            }
            
            return risks;
        }

        function checkCompliance(content) {
            const compliance = {};
            
            for (const [framework, patterns] of Object.entries(compliancePatterns)) {
                const foundClauses = [];
                
                for (const pattern of patterns) {
                    const matches = content.matchAll(pattern);
                    for (const match of matches) {
                        // Find proper sentence boundaries
                        const sentenceStart = findSentenceBoundary(content, match.index, 'backward');
                        const sentenceEnd = findSentenceBoundary(content, match.index + match[0].length, 'forward');
                        const context = content.substring(sentenceStart, sentenceEnd).trim();
                        
                        foundClauses.push({
                            match: match[0],
                            context: context
                        });
                    }
                }
                
                if (foundClauses.length > 0) {
                    compliance[framework] = foundClauses;
                }
            }
            
            return compliance;
        }

        function calculateFairnessScore(risks, compliance) {
            let baseScore = 100;
            
            // Deduct points for risks
            for (const [riskType, clauses] of Object.entries(risks)) {
                if (riskType in riskDeductions) {
                    baseScore -= riskDeductions[riskType];
                }
            }
            
            // Add points for compliance
            for (const [framework, clauses] of Object.entries(compliance)) {
                if (framework in complianceBonuses) {
                    baseScore += complianceBonuses[framework];
                }
            }
            
            return Math.max(0, Math.min(100, baseScore));
        }

        function generateRecommendations(risks, compliance) {
            const recommendations = [];
            
            if (risks.mandatory_arbitration) {
                recommendations.push("‚ö†Ô∏è Remove mandatory arbitration clause - users should have right to sue in court");
            }
            if (risks.broad_liability_waivers) {
                recommendations.push("‚ö†Ô∏è Limit liability waivers - complete immunity is unfair to users");
            }
            if (risks.broad_termination_rights) {
                recommendations.push("‚ö†Ô∏è Add due process for account termination - vague standards are unfair");
            }
            if (risks.automatic_renewal) {
                recommendations.push("‚ö†Ô∏è Make subscription cancellation easier - automatic renewal can be deceptive");
            }
            if (risks.excessive_data_collection) {
                recommendations.push("üö® Limit data collection to what's necessary - excessive collection violates privacy");
            }
            if (risks.no_refunds) {
                recommendations.push("‚ö†Ô∏è Provide clear refund policies - no-refund policies can be unfair");
            }
            if (risks.data_selling) {
                recommendations.push("üö® Prohibit selling user data - this violates user trust and privacy");
            }
            if (risks.unilateral_changes) {
                recommendations.push("‚ö†Ô∏è Require notice for material changes - unilateral changes are unfair");
            }
            if (risks.sole_discretion_clauses) {
                recommendations.push("‚ö†Ô∏è Add objective standards - 'sole discretion' is too vague");
            }
            if (risks.waiver_of_rights) {
                recommendations.push("üö® Remove broad rights waivers - users should retain basic legal rights");
            }
            if (risks.extensive_data_sharing) {
                recommendations.push("üö® Limit data sharing - extensive sharing with third parties violates privacy");
            }
            if (risks.indefinite_data_retention) {
                recommendations.push("‚ö†Ô∏è Set clear data retention limits - indefinite retention is unfair");
            }
            if (risks.broad_data_use) {
                recommendations.push("‚ö†Ô∏è Limit data use to stated purposes - broad use violates user expectations");
            }
            if (risks.lack_of_user_control) {
                recommendations.push("üö® Give users control over their data - lack of control is unfair");
            }
            
            // Add compliance recommendations
            if (!compliance.gdpr) {
                recommendations.push("üìã Add GDPR compliance clauses for EU users");
            }
            if (!compliance.ccpa) {
                recommendations.push("üìã Add CCPA compliance for California users");
            }
            if (!compliance.fair_terms) {
                recommendations.push("üìã Add fair dispute resolution process");
            }
            if (!compliance.privacy_best_practices) {
                recommendations.push("üìã Implement privacy by design principles");
            }
            
            if (recommendations.length === 0) {
                recommendations.push("‚úÖ Document appears to have fair terms");
            }
            
            return recommendations;
        }

        function displayResults(risks, compliance, fairnessScore, recommendations) {
            // Display score
            const scoreElement = document.getElementById('scoreNumber');
            const statusElement = document.getElementById('status');
            
            scoreElement.textContent = `${fairnessScore}/100`;
            scoreElement.className = 'score-number';
            
            if (fairnessScore >= 80) {
                statusElement.textContent = '‚úÖ FAIR';
                scoreElement.classList.add('score-fair');
            } else if (fairnessScore >= 60) {
                statusElement.textContent = '‚ö†Ô∏è MODERATE';
                scoreElement.classList.add('score-moderate');
            } else {
                statusElement.textContent = 'üö® UNFAIR';
                scoreElement.classList.add('score-unfair');
            }
            
            // Display risks
            const riskAnalysis = document.getElementById('riskAnalysis');
            if (Object.keys(risks).length > 0) {
                let riskHtml = '<h3>‚ö†Ô∏è Risk Analysis</h3>';
                for (const [riskType, clauses] of Object.entries(risks)) {
                    const riskName = riskType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    riskHtml += `<div class="result-item risk">
                        <strong>${riskName}:</strong> ${clauses.length} concerning clause(s)
                        <ul style="margin-top: 10px; margin-left: 20px;">
                    `;
                    clauses.slice(0, 2).forEach(clause => {
                        const context = clause.context.length > 80 ? 
                            clause.context.substring(0, 80) + '...' : clause.context;
                        riskHtml += `<li>"${context}"</li>`;
                    });
                    riskHtml += '</ul></div>';
                }
                riskAnalysis.innerHTML = riskHtml;
            } else {
                riskAnalysis.innerHTML = '<div class="result-item compliance"><strong>‚úÖ No risks detected</strong></div>';
            }
            
            // Display compliance
            const complianceCheck = document.getElementById('complianceCheck');
            if (Object.keys(compliance).length > 0) {
                let complianceHtml = '<h3>üõ°Ô∏è Compliance Check</h3>';
                for (const [framework, clauses] of Object.entries(compliance)) {
                    const frameworkName = framework.toUpperCase();
                    complianceHtml += `<div class="result-item compliance">
                        <strong>${frameworkName}:</strong> ‚úÖ Found ${clauses.length} compliance-related clause(s)
                    </div>`;
                }
                complianceCheck.innerHTML = complianceHtml;
            } else {
                complianceCheck.innerHTML = '<div class="result-item risk"><strong>‚ùå No compliance clauses found</strong></div>';
            }
            
            // Display recommendations
            const recommendationsDiv = document.getElementById('recommendations');
            let recHtml = '<h3>üí° Recommendations</h3>';
            recommendations.forEach(rec => {
                recHtml += `<div class="result-item recommendation">${rec}</div>`;
            });
            recommendationsDiv.innerHTML = recHtml;
        }

        function analyzeDocument() {
            console.log('analyzeDocument function called');
            const content = document.getElementById('documentContent').value;
            const title = document.getElementById('documentTitle').value;
            
            console.log('Content length:', content.length);
            console.log('Title:', title);
            
            if (!content.trim()) {
                alert('Please enter document content');
                return;
            }
            
            // Show loading
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            
            // Simulate processing time
            setTimeout(() => {
                const risks = detectRisks(content);
                const compliance = checkCompliance(content);
                const fairnessScore = calculateFairnessScore(risks, compliance);
                const recommendations = generateRecommendations(risks, compliance);
                
                // Store analysis for chatbot
                currentAnalysis = { risks, compliance, fairnessScore, recommendations };
                
                // Hide loading, show results
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');
                
                displayResults(risks, compliance, fairnessScore, recommendations);
            }, 2000);
        }

        function loadSampleDocument() {
            document.getElementById('documentTitle').value = 'Fair Terms of Service Example';
            document.getElementById('documentContent').value = `Terms of Service - Fair Example

1. FAIR DISPUTE RESOLUTION
We prefer to resolve disputes through direct communication. If that fails, we offer mediation. You retain the right to sue in court for any dispute. No mandatory arbitration.

2. REASONABLE LIABILITY
We are liable for damages caused by our negligence up to the amount you paid us. We do not limit liability for personal injury or fraud.

3. MINIMAL DATA COLLECTION
We only collect data necessary to provide our service:
- Account information for login
- Payment information for transactions
- Basic usage data to improve service quality

4. NO DATA SELLING
We never sell your personal information to third parties. We only share data with service providers under strict confidentiality agreements.

5. TRANSPARENT CHANGES
We provide 60 days notice for any changes to these terms. You can cancel your account and receive a prorated refund if you disagree with changes.

6. FAIR TERMINATION
We only terminate accounts for clear violations of these terms with 30 days notice and opportunity to appeal.

7. GENEROUS REFUND POLICY
Full refunds available within 90 days for any reason. Prorated refunds for annual subscriptions.

8. LIMITED DATA RETENTION
We delete your data within 30 days of account closure, except as required by law.

9. STRONG USER CONTROL
You can:
- Delete your account anytime
- Export all your data
- Opt out of all data collection
- Request data deletion
- Disable tracking cookies

10. COMPREHENSIVE PRIVACY RIGHTS
- GDPR compliance for EU users
- CCPA compliance for California users
- Right to know what data we collect
- Right to request deletion
- Right to data portability
- Right to opt out of data sharing

11. PRIVACY BY DESIGN
- Data minimization principles
- Purpose limitation
- Storage limitation
- Accuracy and security
- Transparency and accountability

12. CONTACT INFORMATION
For questions about these terms or your rights:
- Email: privacy@example.com
- Phone: 1-800-EXAMPLE
- Address: 123 Fair Street, Privacy City, PC 12345

We believe in fair, transparent terms that protect both users and our business.`;
        }

        // Chatbot functionality
        let currentAnalysis = null;

        function formatMessage(content) {
            // Convert markdown-style formatting to HTML
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **bold** to <strong>
                .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *italic* to <em>
                .replace(/\n/g, '<br>')                            // newlines to <br>
                .replace(/^- /gm, '‚Ä¢ ')                            // dash bullets to bullet points
                .replace(/^‚Ä¢ /gm, '‚Ä¢ ');                           // ensure bullet points
        }

        function addMessage(content, isUser = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            // Format the content if it's from the bot
            const formattedContent = isUser ? content : formatMessage(content);
            messageDiv.innerHTML = `<div class="message-content">${formattedContent}</div>`;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot-message';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        async function generateChatbotResponse(userMessage) {
                const documentContent = document.getElementById('documentContent').value;
                
            if (!documentContent.trim()) {
                return `üìù <strong>No document loaded!</strong><br><br>
                Please upload or paste a document first, then I can answer questions about it.<br><br>
                You can:<br>
                ‚Ä¢ Paste Terms of Service text<br>
                ‚Ä¢ Upload a document file<br>
                ‚Ä¢ Use the sample documents provided`;
            }
            
            try {
                // Call the backend API
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        document_content: documentContent
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                        }
                
                const data = await response.json();
                return data.response || "I'm sorry, I couldn't generate a response. Please try again.";
                
            } catch (error) {
                console.error('Error calling chatbot API:', error);
                return `ü§ñ <strong>AI Assistant Error</strong><br><br>
                I'm having trouble connecting to my AI brain right now. This might be because:<br>
                ‚Ä¢ The AI service is temporarily unavailable<br>
                ‚Ä¢ There's a network connection issue<br>
                ‚Ä¢ The document is too large to process<br><br>
                <strong>Try:</strong><br>
                ‚Ä¢ Refreshing the page<br>
                ‚Ä¢ Using a shorter document<br>
                ‚Ä¢ Checking your internet connection<br><br>
                Error details: ${error.message}`;
            }
        }

        async function handleChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, true);
            input.value = '';
            
            // Show typing indicator
            addTypingIndicator();
            
            try {
                // Generate response using the AI
                const response = await generateChatbotResponse(message);
                removeTypingIndicator();
                addMessage(response);
            } catch (error) {
                removeTypingIndicator();
                addMessage(`ü§ñ <strong>Error:</strong> ${error.message}`);
            }
        }

        // Update the first analyzeDocument function to store analysis for chatbot

        // Event listeners
        console.log('Setting up event listeners...');
        const analysisForm = document.getElementById('analysisForm');
        console.log('Analysis form found:', analysisForm);
        
        analysisForm.addEventListener('submit', function(e) {
            console.log('Form submitted!');
            e.preventDefault();
            console.log('Prevented default, calling analyzeDocument...');
            analyzeDocument();
        });

        // Chatbot event listeners
        document.getElementById('sendMessage').addEventListener('click', handleChatMessage);
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleChatMessage();
            }
        });

        // Initialize with sample document
        console.log('JavaScript loaded successfully');
        loadSampleDocument();
    </script>
</body>
</html> 